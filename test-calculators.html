<!doctype html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>è¨ˆç®—å™¨æ¸¬è©¦å·¥å…· - CGMH EHRCALC</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                font-size: 32px;
                margin-bottom: 10px;
            }

            .header p {
                font-size: 16px;
                opacity: 0.9;
            }

            .controls {
                padding: 20px 30px;
                background: #f8f9fa;
                border-bottom: 1px solid #dee2e6;
                display: flex;
                gap: 15px;
                align-items: center;
                flex-wrap: wrap;
            }

            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-primary:hover {
                background: #5568d3;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover {
                background: #5a6268;
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .progress-container {
                padding: 20px 30px;
                background: white;
                border-bottom: 1px solid #dee2e6;
            }

            .progress-bar-container {
                width: 100%;
                height: 30px;
                background: #e9ecef;
                border-radius: 15px;
                overflow: hidden;
                margin-bottom: 10px;
            }

            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                transition: width 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
                font-size: 14px;
            }

            .stats {
                display: flex;
                gap: 20px;
                font-size: 14px;
            }

            .stat {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .stat-icon {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
            }

            .stat-icon.success {
                background: #28a745;
                color: white;
            }
            .stat-icon.error {
                background: #dc3545;
                color: white;
            }
            .stat-icon.pending {
                background: #ffc107;
                color: white;
            }
            .stat-icon.total {
                background: #6c757d;
                color: white;
            }

            .results {
                padding: 20px 30px;
                max-height: 600px;
                overflow-y: auto;
            }

            .filter-buttons {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }

            .filter-btn {
                padding: 6px 12px;
                border: 2px solid #dee2e6;
                background: white;
                border-radius: 20px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .filter-btn.active {
                background: #667eea;
                border-color: #667eea;
                color: white;
            }

            .test-item {
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 8px;
                border: 1px solid #dee2e6;
                display: flex;
                gap: 15px;
                align-items: flex-start;
                transition: all 0.2s ease;
            }

            .test-item:hover {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .test-item.success {
                background: #d4edda;
                border-color: #c3e6cb;
            }

            .test-item.error {
                background: #f8d7da;
                border-color: #f5c6cb;
            }

            .test-item.pending {
                background: #fff3cd;
                border-color: #ffeaa7;
            }

            .test-item.testing {
                background: #cfe2ff;
                border-color: #b6d4fe;
                animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.7;
                }
            }

            .test-icon {
                font-size: 24px;
                min-width: 30px;
                text-align: center;
            }

            .test-content {
                flex: 1;
            }

            .test-title {
                font-weight: 600;
                margin-bottom: 5px;
                color: #2c3e50;
            }

            .test-id {
                font-size: 12px;
                color: #6c757d;
                font-family: monospace;
                margin-bottom: 5px;
            }

            .test-detail {
                font-size: 14px;
                color: #495057;
                margin-top: 5px;
            }

            .test-error {
                font-size: 13px;
                color: #721c24;
                background: #f5c6cb;
                padding: 8px;
                border-radius: 4px;
                margin-top: 8px;
                font-family: monospace;
                white-space: pre-wrap;
                word-break: break-word;
            }

            .test-actions {
                display: flex;
                gap: 5px;
                margin-top: 8px;
            }

            .test-actions button {
                padding: 4px 10px;
                font-size: 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                background: #007bff;
                color: white;
            }

            .test-actions button:hover {
                background: #0056b3;
            }

            .summary-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
            }

            .summary-card h3 {
                margin-bottom: 15px;
            }

            .summary-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .summary-stat {
                text-align: center;
            }

            .summary-stat-value {
                font-size: 36px;
                font-weight: 700;
                margin-bottom: 5px;
            }

            .summary-stat-label {
                font-size: 14px;
                opacity: 0.9;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #6c757d;
            }

            .empty-state-icon {
                font-size: 64px;
                margin-bottom: 20px;
                opacity: 0.5;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸ§ª è¨ˆç®—å™¨æ¸¬è©¦å·¥å…·</h1>
                <p>è‡ªå‹•æ¸¬è©¦æ‰€æœ‰è¨ˆç®—å™¨æ¨¡çµ„çš„è¼‰å…¥èˆ‡åŠŸèƒ½</p>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startTestBtn" onclick="startTests()">
                    ğŸš€ é–‹å§‹æ¸¬è©¦
                </button>
                <button class="btn btn-secondary" id="stopTestBtn" onclick="stopTests()" disabled>
                    â¸ï¸ åœæ­¢æ¸¬è©¦
                </button>
                <button class="btn btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
                <button class="btn btn-secondary" onclick="exportResults()">ğŸ“¥ åŒ¯å‡ºå ±å‘Š</button>
            </div>

            <div class="progress-container" id="progressContainer" style="display: none">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-icon total">ğŸ“Š</div>
                        <span>ç¸½æ•¸: <strong id="totalCount">0</strong></span>
                    </div>
                    <div class="stat">
                        <div class="stat-icon success">âœ“</div>
                        <span>æˆåŠŸ: <strong id="successCount">0</strong></span>
                    </div>
                    <div class="stat">
                        <div class="stat-icon error">âœ—</div>
                        <span>å¤±æ•—: <strong id="errorCount">0</strong></span>
                    </div>
                    <div class="stat">
                        <div class="stat-icon pending">â³</div>
                        <span>å¾…æ¸¬: <strong id="pendingCount">0</strong></span>
                    </div>
                </div>
            </div>

            <div class="results">
                <div class="filter-buttons" id="filterButtons" style="display: none">
                    <button
                        class="filter-btn active"
                        data-filter="all"
                        onclick="filterResults('all')"
                    >
                        å…¨éƒ¨ (<span id="filterAll">0</span>)
                    </button>
                    <button
                        class="filter-btn"
                        data-filter="success"
                        onclick="filterResults('success')"
                    >
                        âœ“ æˆåŠŸ (<span id="filterSuccess">0</span>)
                    </button>
                    <button class="filter-btn" data-filter="error" onclick="filterResults('error')">
                        âœ— å¤±æ•— (<span id="filterError">0</span>)
                    </button>
                </div>

                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ§®</div>
                        <h3>æº–å‚™é–‹å§‹æ¸¬è©¦</h3>
                        <p>é»æ“Šã€Œé–‹å§‹æ¸¬è©¦ã€æŒ‰éˆ•ä¾†æ¸¬è©¦æ‰€æœ‰è¨ˆç®—å™¨</p>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import { calculatorModules } from '/js/calculators/index.js';

            window.calculatorModules = calculatorModules;
            window.testResults = [];
            window.isTestingRunning = false;
            window.currentFilter = 'all';

            console.log(`è¼‰å…¥äº† ${calculatorModules.length} å€‹è¨ˆç®—å™¨æ¨¡çµ„`);
        </script>

        <script>
            async function startTests() {
                if (window.isTestingRunning) return;

                window.isTestingRunning = true;
                window.testResults = [];
                window.currentFilter = 'all';

                const startBtn = document.getElementById('startTestBtn');
                const stopBtn = document.getElementById('stopTestBtn');
                const progressContainer = document.getElementById('progressContainer');
                const filterButtons = document.getElementById('filterButtons');

                startBtn.disabled = true;
                stopBtn.disabled = false;
                progressContainer.style.display = 'block';
                filterButtons.style.display = 'flex';

                const calculators = window.calculatorModules;
                const total = calculators.length;

                document.getElementById('totalCount').textContent = total;
                document.getElementById('pendingCount').textContent = total;
                document.getElementById('successCount').textContent = '0';
                document.getElementById('errorCount').textContent = '0';

                const resultsContainer = document.getElementById('resultsContainer');
                resultsContainer.innerHTML = '';

                for (let i = 0; i < calculators.length; i++) {
                    if (!window.isTestingRunning) break;

                    const calc = calculators[i];
                    await testCalculator(calc, i + 1, total);

                    // æ›´æ–°é€²åº¦
                    const progress = Math.round(((i + 1) / total) * 100);
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressBar').textContent = progress + '%';
                }

                // æ¸¬è©¦å®Œæˆ
                window.isTestingRunning = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;

                showSummary();
            }

            async function testCalculator(calc, index, total) {
                const resultItem = createResultItem(calc, 'testing');
                document.getElementById('resultsContainer').appendChild(resultItem);

                // æ»¾å‹•åˆ°ç•¶å‰é …ç›®
                resultItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                const result = {
                    id: calc.id,
                    title: calc.title,
                    success: false,
                    errors: [],
                    warnings: [],
                    details: {}
                };

                try {
                    // æ¸¬è©¦ 1: æª¢æŸ¥æ¨¡çµ„æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                    const moduleUrl = `/js/calculators/${calc.id}/index.js?v=${Date.now()}`;
                    const moduleResponse = await fetch(moduleUrl, { method: 'HEAD' });

                    if (!moduleResponse.ok) {
                        throw new Error(`æ¨¡çµ„æª”æ¡ˆä¸å­˜åœ¨æˆ–ç„¡æ³•è¨ªå• (HTTP ${moduleResponse.status})`);
                    }
                    result.details.fileExists = true;

                    // æ¸¬è©¦ 2: å˜—è©¦è¼‰å…¥æ¨¡çµ„
                    let module;
                    try {
                        module = await import(moduleUrl);
                        result.details.moduleLoaded = true;
                    } catch (importError) {
                        throw new Error(`æ¨¡çµ„è¼‰å…¥å¤±æ•—: ${importError.message}`);
                    }

                    // æ¸¬è©¦ 3: æª¢æŸ¥æ¨¡çµ„çµæ§‹
                    const calculator = Object.values(module)[0];
                    if (!calculator) {
                        throw new Error('æ¨¡çµ„æ²’æœ‰åŒ¯å‡ºè¨ˆç®—å™¨ç‰©ä»¶');
                    }
                    result.details.hasExport = true;

                    // æ¸¬è©¦ 4: æª¢æŸ¥å¿…è¦æ–¹æ³•
                    if (typeof calculator.generateHTML !== 'function') {
                        throw new Error('ç¼ºå°‘ generateHTML æ–¹æ³•');
                    }
                    result.details.hasGenerateHTML = true;

                    // æ¸¬è©¦ 5: å˜—è©¦ç”Ÿæˆ HTML
                    try {
                        const html = calculator.generateHTML();
                        if (!html || typeof html !== 'string') {
                            result.warnings.push('generateHTML è¿”å›å€¼å¯èƒ½ä¸æ­£ç¢º');
                        } else {
                            result.details.htmlLength = html.length;
                        }
                    } catch (htmlError) {
                        result.warnings.push(`generateHTML åŸ·è¡ŒéŒ¯èª¤: ${htmlError.message}`);
                    }

                    // æ¸¬è©¦ 6: æª¢æŸ¥å¯é¸æ–¹æ³•
                    if (typeof calculator.initialize === 'function') {
                        result.details.hasInitialize = true;
                    }

                    if (typeof calculator.calculate === 'function') {
                        result.details.hasCalculate = true;
                    }

                    // æ‰€æœ‰æ¸¬è©¦é€šé
                    result.success = true;
                    updateResultItem(resultItem, calc, 'success', result);
                } catch (error) {
                    result.success = false;
                    result.errors.push(error.message);
                    updateResultItem(resultItem, calc, 'error', result);
                }

                window.testResults.push(result);
                updateStats();
            }

            function createResultItem(calc, status) {
                const item = document.createElement('div');
                item.className = `test-item ${status}`;
                item.id = `test-${calc.id}`;
                item.dataset.calcId = calc.id;
                item.dataset.status = status;

                const icon =
                    status === 'testing'
                        ? 'â³'
                        : status === 'success'
                          ? 'âœ…'
                          : status === 'error'
                            ? 'âŒ'
                            : 'â³';

                item.innerHTML = `
                <div class="test-icon">${icon}</div>
                <div class="test-content">
                    <div class="test-title">${calc.title}</div>
                    <div class="test-id">ID: ${calc.id}</div>
                    <div class="test-detail">æ¸¬è©¦ä¸­...</div>
                </div>
            `;

                return item;
            }

            function updateResultItem(item, calc, status, result) {
                item.className = `test-item ${status}`;
                item.dataset.status = status;

                const icon = status === 'success' ? 'âœ…' : 'âŒ';

                let detailsHtml = '';
                if (status === 'success') {
                    const details = [];
                    if (result.details.hasInitialize) details.push('âœ“ æœ‰ initialize');
                    if (result.details.hasCalculate) details.push('âœ“ æœ‰ calculate');
                    if (result.details.htmlLength)
                        details.push(`âœ“ HTML (${result.details.htmlLength} å­—å…ƒ)`);

                    detailsHtml = `<div class="test-detail">âœ“ æ‰€æœ‰æ¸¬è©¦é€šé ${details.length > 0 ? 'â€¢ ' + details.join(' â€¢ ') : ''}</div>`;

                    if (result.warnings.length > 0) {
                        detailsHtml += `<div class="test-detail" style="color: #856404;">âš ï¸ è­¦å‘Š: ${result.warnings.join(', ')}</div>`;
                    }
                } else {
                    detailsHtml = `<div class="test-detail">âœ— æ¸¬è©¦å¤±æ•—</div>`;
                    if (result.errors.length > 0) {
                        detailsHtml += `<div class="test-error">${result.errors.join('\n')}</div>`;
                    }
                }

                const actionsHtml = `
                <div class="test-actions">
                    <button onclick="retestCalculator('${calc.id}')">é‡æ–°æ¸¬è©¦</button>
                    <button onclick="openCalculator('${calc.id}')">é–‹å•Ÿè¨ˆç®—å™¨</button>
                </div>
            `;

                item.innerHTML = `
                <div class="test-icon">${icon}</div>
                <div class="test-content">
                    <div class="test-title">${calc.title}</div>
                    <div class="test-id">ID: ${calc.id}</div>
                    ${detailsHtml}
                    ${actionsHtml}
                </div>
            `;

                // æ‡‰ç”¨ç•¶å‰ç¯©é¸
                applyCurrentFilter();
            }

            function updateStats() {
                const results = window.testResults;
                const total = window.calculatorModules.length;
                const tested = results.length;
                const success = results.filter(r => r.success).length;
                const error = results.filter(r => !r.success).length;
                const pending = total - tested;

                document.getElementById('successCount').textContent = success;
                document.getElementById('errorCount').textContent = error;
                document.getElementById('pendingCount').textContent = pending;

                document.getElementById('filterAll').textContent = tested;
                document.getElementById('filterSuccess').textContent = success;
                document.getElementById('filterError').textContent = error;
            }

            function showSummary() {
                const results = window.testResults;
                const total = results.length;
                const success = results.filter(r => r.success).length;
                const error = results.filter(r => !r.success).length;
                const successRate = Math.round((success / total) * 100);

                const summaryCard = document.createElement('div');
                summaryCard.className = 'summary-card';
                summaryCard.innerHTML = `
                <h3>ğŸ‰ æ¸¬è©¦å®Œæˆï¼</h3>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-value">${total}</div>
                        <div class="summary-stat-label">ç¸½è¨ˆç®—å™¨æ•¸</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${success}</div>
                        <div class="summary-stat-label">æ¸¬è©¦é€šé</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${error}</div>
                        <div class="summary-stat-label">æ¸¬è©¦å¤±æ•—</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${successRate}%</div>
                        <div class="summary-stat-label">æˆåŠŸç‡</div>
                    </div>
                </div>
            `;

                const resultsContainer = document.getElementById('resultsContainer');
                resultsContainer.insertBefore(summaryCard, resultsContainer.firstChild);
            }

            function stopTests() {
                window.isTestingRunning = false;
                document.getElementById('startTestBtn').disabled = false;
                document.getElementById('stopTestBtn').disabled = true;
            }

            function clearResults() {
                window.testResults = [];
                document.getElementById('resultsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ§®</div>
                    <h3>æº–å‚™é–‹å§‹æ¸¬è©¦</h3>
                    <p>é»æ“Šã€Œé–‹å§‹æ¸¬è©¦ã€æŒ‰éˆ•ä¾†æ¸¬è©¦æ‰€æœ‰è¨ˆç®—å™¨</p>
                </div>
            `;
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('filterButtons').style.display = 'none';
            }

            function filterResults(filter) {
                window.currentFilter = filter;

                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === filter);
                });

                applyCurrentFilter();
            }

            function applyCurrentFilter() {
                const filter = window.currentFilter;
                const items = document.querySelectorAll('.test-item');

                items.forEach(item => {
                    if (filter === 'all') {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = item.dataset.status === filter ? 'flex' : 'none';
                    }
                });
            }

            async function retestCalculator(calcId) {
                const calc = window.calculatorModules.find(c => c.id === calcId);
                if (!calc) return;

                // ç§»é™¤èˆŠçµæœ
                window.testResults = window.testResults.filter(r => r.id !== calcId);

                const item = document.getElementById(`test-${calcId}`);
                if (item) {
                    item.remove();
                }

                await testCalculator(calc, 0, 0);
                updateStats();
            }

            function openCalculator(calcId) {
                window.open(`calculator.html?name=${calcId}`, '_blank');
            }

            function exportResults() {
                const results = window.testResults;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `calculator-test-report-${timestamp}.json`;

                const report = {
                    timestamp: new Date().toISOString(),
                    total: results.length,
                    success: results.filter(r => r.success).length,
                    error: results.filter(r => !r.success).length,
                    results: results
                };

                const blob = new Blob([JSON.stringify(report, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            // è®“å‡½æ•¸å¯ä»¥å¾å…¨åŸŸè¨ªå•
            window.startTests = startTests;
            window.stopTests = stopTests;
            window.clearResults = clearResults;
            window.filterResults = filterResults;
            window.retestCalculator = retestCalculator;
            window.openCalculator = openCalculator;
            window.exportResults = exportResults;
        </script>
    </body>
</html>
