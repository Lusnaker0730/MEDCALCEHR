name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [18.x, 20.x]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: TypeScript type check
              run: npm run type-check

            - name: Build with Vite
              run: npm run build

            - name: Run linting
              run: npm run lint
              continue-on-error: true

            - name: Run tests with coverage
              run: npm run test:coverage

            - name: Upload coverage to Codecov
              if: matrix.node-version == '20.x'
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-medcalc
                  fail_ci_if_error: false

            - name: Upload coverage report artifact
              if: matrix.node-version == '20.x'
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 30

            - name: Upload build artifact
              if: matrix.node-version == '20.x'
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/
                  retention-days: 7

    e2e-tests:
        runs-on: ubuntu-latest
        needs: [build-and-test]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js 20.x
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build with Vite
              run: npm run build

            - name: Install Playwright Chromium
              run: npx playwright install --with-deps chromium

            - name: Run E2E tests (Chromium)
              run: npx playwright test --project=chromium

            - name: Upload Playwright report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30

            - name: Upload test results (traces)
              uses: actions/upload-artifact@v4
              if: failure()
              with:
                  name: test-results
                  path: test-results/
                  retention-days: 30

    accessibility:
        runs-on: ubuntu-latest
        needs: [build-and-test]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js 20.x
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run accessibility unit tests
              run: node --experimental-vm-modules node_modules/jest/bin/jest.js src/__tests__/a11y.test.ts

    security-audit:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run npm audit
              run: npm audit --audit-level=high
              continue-on-error: true

    sbom:
        runs-on: ubuntu-latest
        needs: [build-and-test]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Generate SBOM
              run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

            - name: Upload SBOM artifact
              uses: actions/upload-artifact@v4
              with:
                  name: sbom
                  path: sbom.json
                  retention-days: 90

    docker-build:
        runs-on: ubuntu-latest
        needs: [build-and-test, e2e-tests]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              run: |
                  docker build \
                    --build-arg BUILD_VERSION=${{ github.sha }} \
                    --build-arg BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
                    -t medcalc-ehr:latest .

            - name: Test Docker container
              run: |
                  docker run -d --name test-container -p 8080:80 medcalc-ehr:latest
                  sleep 5
                  curl -f http://localhost:8080/health-check.html || exit 1
                  curl -f http://localhost:8080/api/health || exit 1
                  docker stop test-container
