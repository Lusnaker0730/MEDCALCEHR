name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [18.x, 20.x]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build TypeScript
              run: npm run build:ts

            - name: Run linting
              run: npm run lint
              continue-on-error: true

            - name: Run tests with coverage
              run: npm run test:coverage

            - name: Upload coverage to Codecov
              if: matrix.node-version == '20.x'
              uses: codecov/codecov-action@v4
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-medcalc
                  fail_ci_if_error: false

            - name: Upload coverage report artifact
              if: matrix.node-version == '20.x'
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 30

    type-check:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: TypeScript type check
              run: npx tsc --noEmit

    security-audit:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run npm audit
              run: npm audit --audit-level=high
              continue-on-error: true

    e2e-tests:
        runs-on: ubuntu-latest
        needs: [build-and-test]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js 20.x
              uses: actions/setup-node@v4
              with:
                  node-version: '20.x'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build TypeScript
              run: npm run build:ts

            - name: Install Playwright Chromium
              run: npx playwright install --with-deps chromium

            - name: Run E2E tests (Chromium)
              run: npx playwright test --project=chromium

            - name: Upload Playwright report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30

            - name: Upload test results (traces)
              uses: actions/upload-artifact@v4
              if: failure()
              with:
                  name: test-results
                  path: test-results/
                  retention-days: 30

    docker-build:
        runs-on: ubuntu-latest
        needs: [build-and-test, type-check]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              run: docker build -t medcalc-ehr:latest .

            - name: Test Docker container
              run: |
                  docker run -d --name test-container -p 8080:80 medcalc-ehr:latest
                  sleep 5
                  curl -f http://localhost:8080/health-check.html || exit 1
                  docker stop test-container
