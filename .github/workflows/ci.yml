# CI/CD Pipeline for MedCalc EHR
# é†«ç™‚è¨ˆç®—å™¨ FHIR æ•´åˆç³»çµ±æŒçºŒæ•´åˆå·¥ä½œæµ

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  # ============================================
  lint:
    name: ðŸ” Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ” Run ESLint
        run: npm run lint
        continue-on-error: true  # æš«æ™‚å…è¨± lint éŒ¯èª¤

      - name: ðŸ’… Check formatting
        run: npm run format:check
        continue-on-error: true  # æš«æ™‚å…è¨±æ ¼å¼éŒ¯èª¤

  # ============================================
  # TypeScript é¡žåž‹æª¢æŸ¥
  # ============================================
  typecheck:
    name: ðŸ“ TypeScript Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”§ TypeScript compile check
        run: npx tsc --noEmit
        continue-on-error: true  # æš«æ™‚å…è¨±é¡žåž‹éŒ¯èª¤ï¼ˆé–‹ç™¼éšŽæ®µï¼‰

  # ============================================
  # å–®å…ƒæ¸¬è©¦
  # ============================================
  test:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ§ª Run tests
        run: npm test -- --passWithNoTests --forceExit --detectOpenHandles
        continue-on-error: true  # æ¸¬è©¦æ­£åœ¨èª¿æ•´ä¸­

      - name: ðŸ“Š Upload coverage report
        uses: codecov/codecov-action@v4
        if: success()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ============================================
  # å»ºç½®é©—è­‰
  # ============================================
  build:
    name: ðŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”§ Compile TypeScript
        run: npx tsc

      - name: ðŸ“ Verify build output
        run: |
          echo "ðŸ“ Checking build output..."
          ls -la js/
          ls -la js/calculators/ | head -20
          echo "âœ… Build output verified"

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            js/
            css/
            index.html
            launch.html
          retention-days: 7

  # ============================================
  # Docker å»ºç½®
  # ============================================
  docker:
    name: ðŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”§ Build Docker image
        run: |
          docker build -t medcalcehr:${{ github.sha }} .
          docker build -t medcalcehr:latest .

      - name: ðŸ” Scan for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'medcalcehr:latest'
          format: 'table'
          exit-code: '0'  # æš«ä¸é˜»æ“‹ï¼ˆåƒ…å ±å‘Šï¼‰
          severity: 'CRITICAL,HIGH'

  # ============================================
  # å®‰å…¨æ€§æŽƒæ
  # ============================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”’ Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: ðŸ” Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

  # ============================================
  # è¨ˆç®—å™¨é©—è­‰ï¼ˆé†«ç™‚è»Ÿé«”å“è³ªï¼‰
  # ============================================
  medical-validation:
    name: ðŸ¥ Medical Calculator Validation
    runs-on: ubuntu-latest
    needs: [build]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”§ Compile TypeScript
        run: npx tsc

      - name: ðŸ“Š Count calculators
        run: |
          echo "ðŸ“Š Calculator Statistics"
          echo "========================"
          TS_COUNT=$(find src/calculators -name "index.ts" | wc -l)
          JS_COUNT=$(find js/calculators -name "index.js" -o -name "index.d.ts" | wc -l)
          echo "TypeScript sources: $TS_COUNT"
          echo "Compiled outputs: $JS_COUNT"
          
      - name: âœ… Validate calculator structure
        run: |
          echo "âœ… Validating calculator exports..."
          # æª¢æŸ¥æ‰€æœ‰è¨ˆç®—å™¨æ˜¯å¦æœ‰æ­£ç¢ºçš„ export
          for file in js/calculators/*/index.js; do
            if [ -f "$file" ]; then
              if grep -q "export" "$file"; then
                echo "âœ… $(dirname $file | xargs basename)"
              else
                echo "âš ï¸  $(dirname $file | xargs basename) - missing export"
              fi
            fi
          done | head -30

  # ============================================
  # éƒ¨ç½²ï¼ˆåƒ… main åˆ†æ”¯ï¼‰
  # ============================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: ðŸš€ Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "This step would deploy to your staging server"
          # åœ¨é€™è£¡åŠ å…¥å¯¦éš›éƒ¨ç½²å‘½ä»¤
          # ä¾‹å¦‚: rsync, scp, æˆ– cloud provider CLI

  deploy-production:
    name: ðŸŒ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build, security, docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: ðŸŒ Deploy to production
        run: |
          echo "ðŸŒ Deploying to production environment..."
          echo "This step would deploy to your production server"
          # åœ¨é€™è£¡åŠ å…¥å¯¦éš›éƒ¨ç½²å‘½ä»¤

  # ============================================
  # é€šçŸ¥
  # ============================================
  notify:
    name: ðŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build]
    if: always()
    
    steps:
      - name: ðŸ“¢ Summary
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeCheck | ${{ needs.typecheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
