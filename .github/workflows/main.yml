name: CI/CD Pipeline

on:
    push:
        branches: ['main', 'master']
    pull_request:
        branches: ['main', 'master']
    workflow_dispatch:

jobs:
    build-and-test:
        name: ğŸ›¡ï¸ Build, Lint & Test
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: ğŸ“¦ Install dependencies
              run: npm ci

            - name: ğŸ¨ Check Formatting
              run: npm run format:check

            - name: ğŸ” Lint Code
              run: npm run lint

            - name: ğŸ”¨ TypeScript Build
              # ç·¨è­¯ TypeScript ç¢ºä¿æ²’æœ‰å‹åˆ¥éŒ¯èª¤
              run: npm run build:ts

            - name: ğŸ§¹ Artifact Check
              # ç¢ºä¿ç·¨è­¯å¾Œçš„æª”æ¡ˆ (.js) æ²’æœ‰è¢«éŒ¯èª¤åœ°æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ä¸­
              run: |
                  if git ls-files --error-unmatch js/calculators/**/*.js > /dev/null 2>&1; then
                    echo "âŒ Error: js/calculators/ ç›®éŒ„ä¸‹çš„ç·¨è­¯æª”æ¡ˆè¢« Git è¿½è¹¤äº†ã€‚è«‹å°‡å…¶ç§»é™¤ä¸¦åŠ å…¥ .gitignoreã€‚"
                    exit 1
                  fi
                  echo "âœ… No compiled artifacts tracked in git."

            - name: ğŸ§ª Run Tests
              # åŸ·è¡Œæ¸¬è©¦ (åŒ…å«æ–°çš„ Smoke Test)
              run: npm test
