name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  quality-check:
    name: ğŸ›¡ï¸ Code Quality & Build
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ¨ Check Formatting
      run: npm run format:check

    - name: ğŸ” Lint Code
      run: npm run lint

    - name: ğŸ”¨ TypeScript Build
      # é€™ä¸€æ­¥éå¸¸é‡è¦ï¼Œç¢ºä¿æ‰€æœ‰ TS æª”æ¡ˆéƒ½èƒ½æ­£ç¢ºç·¨è­¯ï¼Œæ²’æœ‰å‹åˆ¥éŒ¯èª¤
      run: npm run build:ts

    - name: ğŸ§¹ Artifact Check
      # ç¢ºä¿ç·¨è­¯å¾Œçš„æª”æ¡ˆ (.js, .d.ts in js/) æ²’æœ‰è¢«è¿½è¹¤
      # å¦‚æœé€™äº›æª”æ¡ˆå­˜åœ¨æ–¼ repo ä¸­ï¼Œè…³æœ¬æœƒå ±éŒ¯ï¼Œæç¤ºé–‹ç™¼è€…æ‡‰è©²å°‡å…¶åŠ å…¥ .gitignore
      run: |
        if git ls-files --error-unmatch js/calculators/**/*.js > /dev/null 2>&1; then
          echo "âŒ Error: Compiled JS files in js/calculators/ are tracked by Git. They should be ignored."
          exit 1
        fi
        echo "âœ… No compiled artifacts tracked in git."

  # åŸ·è¡Œæ¸¬è©¦ (æ¸¬è©¦ src/ ä¸‹çš„ TypeScript æºç¢¼)
  test:
    name: ğŸ§ª Run Tests
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Execute Tests
        run: npm test
