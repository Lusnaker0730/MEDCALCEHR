# å®šæœŸç¶­è­·å·¥ä½œæµ
# æ¯é€±åŸ·è¡Œä¾è³´æ›´æ–°æª¢æŸ¥å’Œä»£ç¢¼å¥åº·åº¦æª¢æŸ¥

name: Maintenance

on:
  schedule:
    # æ¯é€±ä¸€ UTC 02:00 (å°ç£æ™‚é–“ 10:00)
    - cron: '0 2 * * 1'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # ä¾è³´å®‰å…¨æª¢æŸ¥
  # ============================================
  dependency-audit:
    name: ðŸ”’ Dependency Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”’ Security audit
        run: |
          echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š Check outdated packages
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY 2>&1 || echo "All packages up to date" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ä»£ç¢¼å¥åº·åº¦å ±å‘Š
  # ============================================
  code-health:
    name: ðŸ“Š Code Health
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ“Š Code statistics
        run: |
          echo "## ðŸ“Š Code Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### TypeScript Files" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          TS_FILES=$(find src -name "*.ts" | wc -l)
          TS_LINES=$(find src -name "*.ts" -exec cat {} \; | wc -l)
          CALC_COUNT=$(find src/calculators -name "index.ts" | wc -l)
          
          echo "| TypeScript files | $TS_FILES |" >> $GITHUB_STEP_SUMMARY
          echo "| Total lines | $TS_LINES |" >> $GITHUB_STEP_SUMMARY
          echo "| Calculator modules | $CALC_COUNT |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Check for TODO/FIXME
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ TODO/FIXME Comments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TODO_COUNT=$(grep -r "TODO\|FIXME" src/ --include="*.ts" | wc -l || echo "0")
          echo "Found $TODO_COUNT TODO/FIXME comments" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -r "TODO\|FIXME" src/ --include="*.ts" | head -10 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # è¨ˆç®—å™¨é©—è­‰
  # ============================================
  calculator-validation:
    name: ðŸ¥ Calculator Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”§ Compile TypeScript
        run: npx tsc

      - name: ðŸ¥ Validate calculators
        run: |
          echo "## ðŸ¥ Calculator Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Calculator Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åˆ—å‡ºæ‰€æœ‰è¨ˆç®—å™¨
          CALCULATORS=$(find src/calculators -mindepth 1 -maxdepth 1 -type d | wc -l)
          echo "Total calculator directories: $CALCULATORS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æª¢æŸ¥æ¯å€‹è¨ˆç®—å™¨æ˜¯å¦æœ‰å¿…è¦çš„æª”æ¡ˆ
          echo "### Missing Files Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          MISSING=0
          for dir in src/calculators/*/; do
            if [ ! -f "${dir}index.ts" ]; then
              echo "âš ï¸ Missing index.ts: $(basename $dir)" >> $GITHUB_STEP_SUMMARY
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ "$MISSING" -eq 0 ]; then
            echo "âœ… All calculators have index.ts files" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # ç”¢ç”Ÿç¶­è­·å ±å‘Š
  # ============================================
  report:
    name: ðŸ“‹ Generate Report
    runs-on: ubuntu-latest
    needs: [dependency-audit, code-health, calculator-validation]
    
    steps:
      - name: ðŸ“‹ Create Issue (if needed)
        uses: actions/github-script@v8
        with:
          script: |
            // æª¢æŸ¥æ˜¯å¦éœ€è¦å»ºç«‹ issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'maintenance',
              state: 'open'
            });
            
            // å¦‚æžœå·²æœ‰é–‹æ”¾çš„ç¶­è­· issueï¼Œå‰‡ä¸å»ºç«‹æ–°çš„
            if (issues.length > 0) {
              console.log('Maintenance issue already exists');
              return;
            }
            
            // å»ºç«‹æ–°çš„ç¶­è­·å ±å‘Š issue
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `é€±ç¶­è­·å ±å‘Š - ${date}`,
              body: `## è‡ªå‹•ç¶­è­·å ±å‘Š\n\nè«‹æŸ¥çœ‹ [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) äº†è§£è©³ç´°è³‡è¨Šã€‚`,
              labels: ['maintenance', 'automated']
            });
        continue-on-error: true
