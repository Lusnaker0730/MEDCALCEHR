name: Calculator Tests

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'js/calculators/**'
      - 'tests/calculators/**'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'js/calculators/**'
      - 'tests/calculators/**'
  workflow_dispatch:

jobs:
  calculator-tests:
    name: Test Calculators
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run all calculator tests
        run: npm test -- tests/calculators/ --verbose

      - name: Test individual calculator modules
        run: |
          echo "üßÆ Testing Individual Calculator Modules"
          echo "========================================"
          
          # BMI-BSA Calculator
          echo "Testing BMI-BSA Calculator..."
          npm test -- tests/calculators/bmi-bsa.test.js
          
          # CKD-EPI Calculator
          echo "Testing CKD-EPI Calculator..."
          npm test -- tests/calculators/ckd-epi.test.js
          
          # APACHE II Calculator
          echo "Testing APACHE II Calculator..."
          npm test -- tests/calculators/apache-ii.test.js
          
          # SOFA Calculator
          echo "Testing SOFA Calculator..."
          npm test -- tests/calculators/sofa.test.js
          
          # GCS Calculator
          echo "Testing GCS Calculator..."
          npm test -- tests/calculators/gcs.test.js
          
          # qSOFA Calculator
          echo "Testing qSOFA Calculator..."
          npm test -- tests/calculators/qsofa.test.js
          
          # CURB-65 Calculator
          echo "Testing CURB-65 Calculator..."
          npm test -- tests/calculators/curb-65.test.js
          
          # Wells PE Calculator
          echo "Testing Wells PE Calculator..."
          npm test -- tests/calculators/wells-pe.test.js
          
          # Wells DVT Calculator
          echo "Testing Wells DVT Calculator..."
          npm test -- tests/calculators/wells-dvt.test.js
          
          # Charlson CCI Calculator
          echo "Testing Charlson CCI Calculator..."
          npm test -- tests/calculators/charlson.test.js
          
          # CrCl Calculator
          echo "Testing Cockcroft-Gault Calculator..."
          npm test -- tests/calculators/crcl.test.js
          
          # Child-Pugh Calculator
          echo "Testing Child-Pugh Calculator..."
          npm test -- tests/calculators/child-pugh.test.js
          
          # ASCVD Calculator
          echo "Testing ASCVD Calculator..."
          npm test -- tests/calculators/ascvd.test.js

      - name: Generate calculator test matrix
        if: always()
        run: |
          cat > calculator-test-matrix.md << 'EOF'
          # Ë®àÁÆóÂô®Ê∏¨Ë©¶Áü©Èô£
          
          ## Â∑≤Ê∏¨Ë©¶ÁöÑË®àÁÆóÂô® (15/92)
          
          | Ë®àÁÆóÂô® | Ê∏¨Ë©¶Êï∏Èáè | ÁãÄÊÖã |
          |--------|----------|------|
          | BMI & BSA | 40+ | ‚úÖ |
          | CKD-EPI GFR | 30+ | ‚úÖ |
          | APACHE II | 35+ | ‚úÖ |
          | SOFA Score | 45+ | ‚úÖ |
          | Glasgow Coma Scale | 30+ | ‚úÖ |
          | qSOFA | 25+ | ‚úÖ |
          | CURB-65 | 25+ | ‚úÖ |
          | Wells PE | 20+ | ‚úÖ |
          | Wells DVT | 25+ | ‚úÖ |
          | Charlson CCI | 40+ | ‚úÖ |
          | Cockcroft-Gault | 35+ | ‚úÖ |
          | Child-Pugh | 40+ | ‚úÖ |
          | ASCVD Risk | 30+ | ‚úÖ |
          
          **Á∏ΩË®à**: 447+ Ê∏¨Ë©¶ÈÄöÈÅé
          
          ## ÂæÖÊ∑ªÂä†Ê∏¨Ë©¶ÁöÑË®àÁÆóÂô® (77/92)
          
          - 2HELPS2B Score
          - 4 A's Test for Delirium
          - 4C Mortality Score for COVID-19
          - 4PEPS
          - 4Ts Score for HIT
          - 6MWD Calculator
          - ABG Analyzer
          - ABL90 FLEX
          - ... (ÈÇÑÊúâ 69 ÂÄãË®àÁÆóÂô®)
          
          ## Ê∏¨Ë©¶Ë¶ÜËìãÁéáÁõÆÊ®ô
          
          - ‚úÖ **Áï∂Ââç**: 15 ÂÄãË®àÁÆóÂô® (16.3%)
          - üéØ **Áü≠ÊúüÁõÆÊ®ô**: 30 ÂÄãË®àÁÆóÂô® (32.6%) - 2 ÈÄ±ÂÖß
          - üéØ **‰∏≠ÊúüÁõÆÊ®ô**: 60 ÂÄãË®àÁÆóÂô® (65.2%) - 1 ÂÄãÊúàÂÖß
          - üéØ **Èï∑ÊúüÁõÆÊ®ô**: 92 ÂÄãË®àÁÆóÂô® (100%) - 2 ÂÄãÊúàÂÖß
          EOF

      - name: Upload test matrix
        uses: actions/upload-artifact@v4
        with:
          name: calculator-test-matrix
          path: calculator-test-matrix.md
          retention-days: 30

      - name: Comment test results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const matrix = fs.readFileSync('calculator-test-matrix.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üßÆ Calculator Test Results\n\n${matrix}`
            });

  coverage-check:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    needs: calculator-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate coverage report
        run: npm test -- --coverage --coverageReporters=html --coverageReporters=text

      - name: Check if coverage meets minimum requirements
        run: |
          echo "Checking coverage thresholds..."
          npm test -- --coverage --coverageThreshold='{
            "global": {
              "lines": 5,
              "statements": 5,
              "functions": 5,
              "branches": 5
            }
          }'

      - name: Upload detailed coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-report
          path: coverage/
          retention-days: 30

  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: calculator-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance benchmarks
        run: |
          echo "üöÄ Performance Benchmarks"
          echo "========================"
          
          # Measure test execution time
          time npm test -- tests/calculators/
          
          echo ""
          echo "üìä Performance Summary:"
          echo "- Total test time recorded above"
          echo "- Average time per test: ~10-20ms (target)"
          echo "- All tests should complete within 10 seconds"

      - name: Check test performance
        run: |
          # Run tests and capture time
          START_TIME=$(date +%s)
          npm test -- tests/calculators/ > /dev/null 2>&1
          END_TIME=$(date +%s)
          
          DURATION=$((END_TIME - START_TIME))
          
          echo "Test execution took: ${DURATION} seconds"
          
          if [ $DURATION -gt 15 ]; then
            echo "‚ö†Ô∏è Warning: Tests took longer than 15 seconds"
            exit 1
          else
            echo "‚úÖ Performance is acceptable"
          fi

