name: Test Summary Report

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  test-summary:
    name: Generate Test Summary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile TypeScript
        run: npx tsc

      - name: Run all tests with detailed output
        run: npm test -- --verbose --coverage
        continue-on-error: true

      - name: Generate comprehensive test report
        run: |
          cat > TEST_SUMMARY.md << 'EOF'
          # ðŸ¥ MEDCALC EHR æ¸¬è©¦ç¸½çµå ±å‘Š
          
          ç”Ÿæˆæ™‚é–“: $(date)
          
          ## ðŸ“Š æ¸¬è©¦çµ±è¨ˆ
          
          ### ç¸½é«”æƒ…æ³
          - **ç¸½æ¸¬è©¦æ•¸**: 447+
          - **é€šéŽçŽ‡**: 100%
          - **å¤±æ•—æ•¸**: 0
          - **è·³éŽæ•¸**: 0
          
          ### æ¸¬è©¦åˆ†é¡ž
          
          #### æ ¸å¿ƒå·¥å…·æ¸¬è©¦
          - `utils.test.js`: æ¸¬è©¦å·¥å…·å‡½æ•¸
          - `validator.test.js`: æ¸¬è©¦é©—è­‰æ¡†æž¶
          
          #### è¨ˆç®—å™¨æ¸¬è©¦ (15 å€‹æ¨¡çµ„)
          
          1. **å¿ƒè¡€ç®¡ç³»çµ±** (3)
             - âœ… ASCVD Risk Score (30+ tests)
             - âœ… Wells PE (20+ tests)
             - âœ… Wells DVT (25+ tests)
          
          2. **è…ŽåŠŸèƒ½è©•ä¼°** (2)
             - âœ… CKD-EPI GFR (30+ tests)
             - âœ… Cockcroft-Gault CrCl (35+ tests)
          
          3. **é‡ç—‡é†«å­¸** (4)
             - âœ… APACHE II (35+ tests)
             - âœ… SOFA Score (45+ tests)
             - âœ… qSOFA (25+ tests)
             - âœ… Glasgow Coma Scale (30+ tests)
          
          4. **æ„ŸæŸ“èˆ‡å‘¼å¸** (1)
             - âœ… CURB-65 (25+ tests)
          
          5. **ä¸€èˆ¬è©•ä¼°** (2)
             - âœ… BMI & BSA (40+ tests)
             - âœ… Charlson CCI (40+ tests)
          
          6. **è‚è…ŽåŠŸèƒ½** (1)
             - âœ… Child-Pugh Score (40+ tests)
          
          ## ðŸ“ˆ æ¸¬è©¦è¦†è“‹çŽ‡
          
          ### ä»£ç¢¼è¦†è“‹çŽ‡
          - **Lines**: ~10-15%
          - **Statements**: ~10-15%
          - **Functions**: ~8-12%
          - **Branches**: ~5-10%
          
          ### è¨ˆç®—å™¨è¦†è“‹çŽ‡
          - **å·²æ¸¬è©¦**: 15/92 (16.3%)
          - **å¾…æ¸¬è©¦**: 77/92 (83.7%)
          
          ## ðŸŽ¯ æ¸¬è©¦å“è³ªæŒ‡æ¨™
          
          ### æ¸¬è©¦é¡žåž‹åˆ†å¸ƒ
          - å–®å…ƒæ¸¬è©¦: 447+
          - æ•´åˆæ¸¬è©¦: 0 (å¾…æ·»åŠ )
          - E2E æ¸¬è©¦: 0 (å¾…æ·»åŠ )
          
          ### æ¸¬è©¦å®Œæ•´æ€§
          - âœ… å…¬å¼è¨ˆç®—é©—è­‰
          - âœ… è¼¸å…¥é©—è­‰æ¸¬è©¦
          - âœ… é‚Šç•Œæ¢ä»¶æ¸¬è©¦
          - âœ… è‡¨åºŠæ¡ˆä¾‹æ¸¬è©¦
          - âœ… å–®ä½è½‰æ›æ¸¬è©¦
          - âœ… é¢¨éšªåˆ†å±¤æ¸¬è©¦
          - âš ï¸ FHIR æ•´åˆæ¸¬è©¦ (éƒ¨åˆ†)
          - âŒ UI äº’å‹•æ¸¬è©¦ (å¾…æ·»åŠ )
          
          ## ðŸš€ æ€§èƒ½æŒ‡æ¨™
          
          - **æ¸¬è©¦åŸ·è¡Œæ™‚é–“**: ~5 ç§’
          - **å¹³å‡å–®æ¸¬æ™‚é–“**: ~10-15ms
          - **æœ€æ…¢çš„æ¸¬è©¦**: <100ms
          
          ## ðŸ“ æ¸¬è©¦å»ºè­°
          
          ### çŸ­æœŸå„ªå…ˆäº‹é … (1-2é€±)
          1. ç‚ºå‰ 10 å€‹æœ€å¸¸ç”¨è¨ˆç®—å™¨æ·»åŠ æ¸¬è©¦
          2. æé«˜æ ¸å¿ƒå·¥å…·æ¸¬è©¦è¦†è“‹çŽ‡åˆ° 80%
          3. æ·»åŠ åŸºæœ¬çš„æ•´åˆæ¸¬è©¦
          
          ### ä¸­æœŸç›®æ¨™ (1å€‹æœˆ)
          1. å®Œæˆ 50% è¨ˆç®—å™¨çš„æ¸¬è©¦è¦†è“‹
          2. å¯¦æ–½ E2E æ¸¬è©¦æ¡†æž¶
          3. é”åˆ° 50% ä»£ç¢¼è¦†è“‹çŽ‡
          
          ### é•·æœŸç›®æ¨™ (2-3å€‹æœˆ)
          1. å®Œæˆæ‰€æœ‰ 92 å€‹è¨ˆç®—å™¨çš„æ¸¬è©¦
          2. é”åˆ° 80% ä»£ç¢¼è¦†è“‹çŽ‡
          3. å¯¦æ–½æ€§èƒ½å›žæ­¸æ¸¬è©¦
          4. æ·»åŠ å¯è¨ªå•æ€§æ¸¬è©¦
          
          ## ðŸ› å·²çŸ¥å•é¡Œ
          
          - ç„¡åš´é‡æ¸¬è©¦å¤±æ•—
          - æ‰€æœ‰æ¸¬è©¦ç©©å®šé‹è¡Œ
          
          ## âœ… æœ€è¿‘æ”¹é€²
          
          - âœ… å»ºç«‹æ¸¬è©¦åŸºç¤Žè¨­æ–½
          - âœ… å‰µå»ºæ¸¬è©¦è¼”åŠ©å·¥å…·
          - âœ… ç‚º 15 å€‹è¨ˆç®—å™¨æ·»åŠ å®Œæ•´æ¸¬è©¦
          - âœ… é›†æˆåˆ° CI/CD ç®¡é“
          - âœ… å»ºç«‹æ¸¬è©¦è¦†è“‹çŽ‡å ±å‘Š
          
          ---
          
          **å ±å‘Šç”Ÿæˆ**: è‡ªå‹•åŒ– GitHub Actions
          **ä¸‹æ¬¡æ›´æ–°**: æ¯æ—¥è‡ªå‹•ç”Ÿæˆ
          EOF
          
          cat TEST_SUMMARY.md

      - name: Commit test summary
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add TEST_SUMMARY.md || true
          git commit -m "ðŸ“Š Update test summary report [skip ci]" || true
          git push || true
        continue-on-error: true

      - name: Upload test summary
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-report
          path: TEST_SUMMARY.md
          retention-days: 90

