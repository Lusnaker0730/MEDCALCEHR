# SMART on FHIR èªè­‰æµç¨‹èªªæ˜

## ğŸ“Š å®Œæ•´èªè­‰æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SMART on FHIR èªè­‰æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥é©Ÿ 1: å¾ EHR æˆ– SMART Launcher å•Ÿå‹•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EHR / Launcher  â”‚
â”‚                  â”‚
â”‚ é»æ“Šå•Ÿå‹•æ‡‰ç”¨ç¨‹å¼  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ é‡å®šå‘åˆ° launch.html
         â”‚ å¸¶åƒæ•¸: ?iss=...&launch=...
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  launch.html                                         â”‚
â”‚  http://localhost:8080/launch.html?iss=...&launch=...â”‚
â”‚                                                       â”‚
â”‚  è¼‰å…¥ FHIR Client åº«                                  â”‚
â”‚  åŸ·è¡Œ: FHIR.oauth2.authorize({                        â”‚
â”‚    client_id: 'my-app',                              â”‚
â”‚    scope: 'launch/patient patient/*.read',           â”‚
â”‚    redirect_uri: './index.html'                      â”‚
â”‚  })                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ è§¸ç™¼ OAuth2 æˆæ¬Šè«‹æ±‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EHR æˆæ¬Šä¼ºæœå™¨   â”‚
â”‚                  â”‚
â”‚  ç”¨æˆ¶ç™»å…¥/æˆæ¬Š    â”‚
â”‚  (æ¸¬è©¦ç’°å¢ƒè‡ªå‹•)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ æˆæ¬ŠæˆåŠŸ
         â”‚ é‡å®šå‘å› index.html
         â”‚ å¸¶åƒæ•¸: ?code=...&state=...
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  index.html                                          â”‚
â”‚  http://localhost:8080/index.html?code=...&state=... â”‚
â”‚                                                       â”‚
â”‚  æª¢æ¸¬åˆ° state åƒæ•¸ â†’ è·³éé‡å®šå‘é‚è¼¯                   â”‚
â”‚  è¼‰å…¥ FHIR Client åº«                                  â”‚
â”‚  åŸ·è¡Œ: FHIR.oauth2.ready()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ äº¤æ›æˆæ¬Šç¢¼ç²å–å­˜å–ä»¤ç‰Œ
         â”‚ åˆå§‹åŒ– FHIR å®¢æˆ¶ç«¯
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FHIR å®¢æˆ¶ç«¯å°±ç·’                                      â”‚
â”‚                                                       â”‚
â”‚  âœ“ å·²å–å¾—å­˜å–ä»¤ç‰Œ                                     â”‚
â”‚  âœ“ å·²å–å¾—ç—…æ‚£ä¸Šä¸‹æ–‡ (patient.id)                      â”‚
â”‚  âœ“ å¯ä»¥å­˜å– FHIR API                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ å‘¼å« displayPatientInfo(client, div)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API è«‹æ±‚: GET /Patient/{id}                          â”‚
â”‚  â†’ å–å¾—ç—…æ‚£åŸºæœ¬è³‡æ–™ (å§“åã€ç”Ÿæ—¥ã€æ€§åˆ¥)                 â”‚
â”‚                                                       â”‚
â”‚  API è«‹æ±‚: GET /Observation?patient={id}&code=...     â”‚
â”‚  â†’ å–å¾—å¯¦é©—å®¤æ•¸æ“š (éœ€è¦æ™‚)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡¯ç¤ºç—…æ‚£è³‡è¨Š                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ‘¤ ç—…æ‚£è³‡è¨Š                                     â”‚ â”‚
â”‚  â”‚ å§“å: John Doe                                 â”‚ â”‚
â”‚  â”‚ å‡ºç”Ÿæ—¥æœŸ: 1980-01-01 (å¹´é½¡: 45)                â”‚ â”‚
â”‚  â”‚ æ€§åˆ¥: Male                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                       â”‚
â”‚  âœ“ å¯ä»¥ä½¿ç”¨æ‰€æœ‰è¨ˆç®—å™¨                                 â”‚
â”‚  âœ“ è¨ˆç®—å™¨å¯ä»¥è‡ªå‹•å¡«å…¥ç—…æ‚£æ•¸æ“š                          â”‚
â”‚  âœ“ å¯ä»¥æŸ¥è©¢å¯¦é©—å®¤æ•¸æ“š                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ é—œéµæª”æ¡ˆèªªæ˜

### 1. launch.html
**ç›®çš„**ï¼šå•Ÿå‹• OAuth2 èªè­‰æµç¨‹

**ä½•æ™‚ä½¿ç”¨**ï¼š
- å¾ EHR ç³»çµ±å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼æ™‚
- é¦–æ¬¡è¨ªå•éœ€è¦ç—…æ‚£ä¸Šä¸‹æ–‡æ™‚

**åšä»€éº¼**ï¼š
```javascript
FHIR.oauth2.authorize({
    client_id: 'my-app',           // æ‡‰ç”¨ç¨‹å¼ ID
    iss: 'FHIRä¼ºæœå™¨URL',          // å¾ URL åƒæ•¸å–å¾—
    scope: 'æ¬Šé™åˆ—è¡¨',              // è«‹æ±‚çš„æ¬Šé™
    redirect_uri: './index.html'   // èªè­‰å¾Œè¿”å›çš„é é¢
});
```

### 2. index.html
**ç›®çš„**ï¼šæ‡‰ç”¨ç¨‹å¼ä¸»é é¢ï¼Œé¡¯ç¤ºè¨ˆç®—å™¨åˆ—è¡¨

**èªè­‰æª¢æŸ¥é‚è¼¯**ï¼š
```javascript
// å¦‚æœæ²’æœ‰ OAuth state ä¸”æ²’æœ‰å·²å­˜åœ¨çš„ sessionï¼Œé‡å®šå‘åˆ° launch
if (!/state=/.test(location.search) && !sessionStorage.getItem('SMART_KEY')) {
    window.location.href = 'launch.html';
}
```

**åˆå§‹åŒ– FHIR å®¢æˆ¶ç«¯**ï¼š
```javascript
FHIR.oauth2.ready()
    .then(client => {
        // å®¢æˆ¶ç«¯å°±ç·’ï¼Œå¯ä»¥å­˜å– FHIR API
        displayPatientInfo(client, patientInfoDiv);
    })
    .catch(error => {
        // èªè­‰å¤±æ•—ï¼Œä½¿ç”¨å¿«å–æˆ–é¡¯ç¤ºéŒ¯èª¤
        console.log('FHIR client not ready');
    });
```

### 3. calculator.html
**ç›®çš„**ï¼šé¡¯ç¤ºå–®å€‹è¨ˆç®—å™¨

**è¡Œç‚º**ï¼š
- åŒæ¨£å˜—è©¦åˆå§‹åŒ– FHIR å®¢æˆ¶ç«¯
- å¦‚æœæˆåŠŸï¼Œå¯ä»¥è‡ªå‹•å¡«å…¥ç—…æ‚£æ•¸æ“š
- å¦‚æœå¤±æ•—ï¼Œä»å¯æ‰‹å‹•è¼¸å…¥ä½¿ç”¨

## ğŸ”„ URL åƒæ•¸èªªæ˜

### å•Ÿå‹•æ™‚ (launch.html)
```
http://localhost:8080/launch.html?iss=FHIR_SERVER&launch=LAUNCH_TOKEN
```
- `iss`: FHIR ä¼ºæœå™¨çš„åŸºç¤ URL
- `launch`: EHR æä¾›çš„å•Ÿå‹•ä»¤ç‰Œï¼ˆåŒ…å«ç—…æ‚£ä¸Šä¸‹æ–‡ï¼‰

### èªè­‰å¾Œ (index.html)
```
http://localhost:8080/index.html?code=AUTH_CODE&state=STATE_TOKEN
```
- `code`: æˆæ¬Šç¢¼ï¼ˆç”¨æ–¼äº¤æ›å­˜å–ä»¤ç‰Œï¼‰
- `state`: ç‹€æ…‹ä»¤ç‰Œï¼ˆé˜²æ­¢ CSRF æ”»æ“Šï¼‰

## ğŸ’¾ Session Storage

FHIR å®¢æˆ¶ç«¯ä½¿ç”¨ sessionStorage å„²å­˜ï¼š
```javascript
{
    'SMART_KEY': {
        serverUrl: 'FHIRä¼ºæœå™¨URL',
        tokenResponse: {
            access_token: 'å­˜å–ä»¤ç‰Œ',
            patient: 'ç—…æ‚£ID',
            expires_in: 3600
        }
    },
    'patientData': 'ç—…æ‚£è³‡æ–™çš„ JSON å­—ä¸²'
}
```

**æª¢æŸ¥æ–¹å¼**ï¼š
1. é–‹å•Ÿé–‹ç™¼è€…å·¥å…· (F12)
2. Application â†’ Session Storage â†’ http://localhost:8080
3. æŸ¥çœ‹ `SMART_KEY` å’Œ `patientData`

## ğŸ§ª æ¸¬è©¦å ´æ™¯

### å ´æ™¯ 1: æ­£å¸¸å•Ÿå‹•ï¼ˆæœ‰ SMART èªè­‰ï¼‰
```
1. SMART Launcher â†’ launch.html?iss=...&launch=...
2. OAuth2 èªè­‰
3. index.html?code=...&state=...
4. å®¢æˆ¶ç«¯åˆå§‹åŒ–æˆåŠŸ
5. é¡¯ç¤ºç—…æ‚£è³‡è¨Š âœ“
```

### å ´æ™¯ 2: ç›´æ¥è¨ªå•ï¼ˆç„¡èªè­‰ï¼‰
```
1. ç›´æ¥è¨ªå• index.html
2. æª¢æŸ¥æ²’æœ‰ state åƒæ•¸
3. æª¢æŸ¥æ²’æœ‰ SMART_KEY
4. è‡ªå‹•é‡å®šå‘åˆ° launch.html
5. ä½¿ç”¨é è¨­ iss å•Ÿå‹•èªè­‰
```

### å ´æ™¯ 3: å·²æœ‰ Session
```
1. è¨ªå• index.html
2. æª¢æŸ¥åˆ° sessionStorage æœ‰ SMART_KEY
3. ä¸é‡å®šå‘ï¼Œç›´æ¥åˆå§‹åŒ–
4. ä½¿ç”¨å¿«å–çš„ç—…æ‚£è³‡æ–™ âœ“
```

### å ´æ™¯ 4: é›¢ç·šæ¨¡å¼
```
1. ç›´æ¥è¨ªå• calculator.html?name=bmi-bsa
2. FHIR å®¢æˆ¶ç«¯åˆå§‹åŒ–å¤±æ•—
3. é¡¯ç¤º "FHIR client not ready"
4. ä»å¯æ‰‹å‹•è¼¸å…¥ä½¿ç”¨è¨ˆç®—å™¨ âœ“
```

## ğŸ› å¸¸è¦‹éŒ¯èª¤è¨ºæ–·

### "FHIR client not ready"
**åŸå› **ï¼š
- æ²’æœ‰ç¶“é OAuth2 èªè­‰æµç¨‹
- Session å·²éæœŸ
- èªè­‰å¤±æ•—

**è§£æ±º**ï¼š
1. æ¸…é™¤ sessionStorage
2. é‡æ–°å¾ SMART Launcher å•Ÿå‹•

### "404 Not Found" (è¨ªå• launch.html)
**åŸå› **ï¼š
- Docker å®¹å™¨ä¸åŒ…å« launch.html

**è§£æ±º**ï¼š
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### "Failed to initialize SMART on FHIR client"
**åŸå› **ï¼š
- ç¶²è·¯é€£ç·šå•é¡Œ
- FHIR ä¼ºæœå™¨ç„¡æ³•è¨ªå•
- client_id ä¸æ­£ç¢º

**è§£æ±º**ï¼š
1. æª¢æŸ¥ç¶²è·¯é€£ç·š
2. ç¢ºèª FHIR ä¼ºæœå™¨ URL æ­£ç¢º
3. æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°çš„è©³ç´°éŒ¯èª¤è¨Šæ¯

### "No patient data available"
**åŸå› **ï¼š
- èªè­‰æˆåŠŸä½†æ²’æœ‰ç—…æ‚£ä¸Šä¸‹æ–‡
- å•Ÿå‹•æ™‚æ²’æœ‰é¸æ“‡ç—…æ‚£

**è§£æ±º**ï¼š
1. åœ¨ SMART Launcher ä¸­é¸æ“‡ç—…æ‚£
2. ç¢ºä¿ scope åŒ…å« `launch/patient`

## ğŸ“š å»¶ä¼¸é–±è®€

- [SMART App Launch è¦ç¯„](http://hl7.org/fhir/smart-app-launch/)
- [FHIR Client JavaScript æ–‡ä»¶](https://github.com/smart-on-fhir/client-js)
- [OAuth 2.0 æˆæ¬Šç¢¼æµç¨‹](https://oauth.net/2/grant-types/authorization-code/)

---

**æç¤º**ï¼šä½¿ç”¨ http://localhost:8080/health-check.html å¯ä»¥è‡ªå‹•æª¢æŸ¥ç³»çµ±ç‹€æ…‹ï¼

